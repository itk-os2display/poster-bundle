/**
 * @name PosterBundle
 * @version v1.0.0
 * @link https://github.com/itk-os2display/poster-bundle
 */
angular.module("posterModule",[]),angular.module("posterModule").config([function(){}]),angular.module("posterModule").directive("posterTool",["$timeout","$http",function(o,c){"use strict";return{restrict:"E",replace:!0,scope:{slide:"=",close:"&",tool:"="},link:function(r,e){function t(e){"subscription"===e?function(){r.loading=!0,r.subscription={},r.numberItems=[1,2,3,4,5,6,7,8,9,10],r.slide.options.subscription||(r.slide.options.subscription={selectedPlaces:{},selectedOrganizers:{},selectedTags:{},selectedNumber:5});o(function(){s("places",r.slide.options.subscription.selectedPlaces),s("organizers",r.slide.options.subscription.selectedOrganizers),s("tags",r.slide.options.subscription.selectedTags),$("#os2display-poster--select-number").on("change",i),r.loading=!1},1e3),i()}():"single"===e&&function(){r.typeSelect="searchName",r.searchName="",r.searchUrl="",r.displayOverrides=!1,r.slide.options.overrides||(r.slide.options.overrides={});r.toggleOverrides=function(){r.displayOverrides=!r.displayOverrides},r.pagerBack=function(){r.pager.centerItem=Math.max(r.pager.centerItem-10,1)},r.pagerForward=function(){r.pager.centerItem=Math.min(r.pager.centerItem+10,r.pager.pagerMax)},r.getPagerPages=function(){r.pager.pages=[];for(var e=parseInt(r.pager.centerItem/10),t=1;t<=10;t++)t+10*e<=r.pager.pagerMax&&r.pager.pages.push(t+10*e);return r.pager.pages},r.calculatePager=function(e){e&&(r.pager={pages:[],currentPage:e.page,pagerMax:e.number_of_pages,itemsPerPage:e.items_per_page,totalResults:e.total_results,centerItem:e.page})},r.search=function(e){r.displayEvent=null,r.events=null;var t={};e&&(t.page=e),"searchName"===r.typeSelect?t.name=r.searchName:"searchUrl"===r.typeSelect&&(t.url=r.searchUrl),c.get("/api/os2display_poster/events",{params:t}).then(function(e){o(function(){r.events=e.data.events,r.meta=e.data.meta,r.calculatePager(r.meta)})})},r.clickEvent=function(e){r.displayEvent=e,1===r.displayEvent.occurrences.length&&r.clickOccurrence(r.displayEvent.occurrences[0])},r.refreshEvent=function(){c.get("/api/os2display_poster/occurrence",{params:{occurrenceId:r.slide.options.data.occurrenceId}}).then(function(e){o(function(){r.slide.options.data=e.data})})},r.clickOccurrence=function(e){c.get("/api/os2display_poster/occurrence",{params:{occurrenceId:e["@id"]}}).then(function(t){o(function(){if(r.slide.options.data=t.data,r.slide.options.data.endDate){var e=new Date(r.slide.options.data.endDate).getTime();r.slide.schedule_to=parseInt(e/1e3)}})}),r.close()}}()}function i(){r.loadingSearchResults=!0,o(function(){var e=angular.copy(r.slide.options.subscription),t={tags:[],places:[],organizers:[],numberOfResults:e.selectedNumber};for(var s in e.selectedTags)null!==(s=e.selectedTags[s])&&t.tags.push(s.id);for(var n in e.selectedOrganizers)null!==(n=e.selectedOrganizers[n])&&t.organizers.push(n.id);for(var a in e.selectedPlaces)null!==(a=e.selectedPlaces[a])&&t.places.push(a.id);c.get("/api/os2display_poster/search_events",{params:t}).then(function(e){var t=e.data.results;o(function(){r.subscription.foundEvents=t,0<r.subscription.foundEvents.length&&(r.slide.options.data=r.subscription.foundEvents[0].occurrence)}),r.loadingSearchResults=!1},function(e){console.log("error",e)})})}function s(t,s){var e=jQuery("#os2display-poster--select-subscription-"+t);for(var n in e.select2({ajax:{url:"/api/os2display_poster/search",dataType:"json",delay:500,data:function(e){return{name:e.term,page:e.page||1,type:t}}},minimumInputLength:1}),e.on("select2:select",function(e){var t=e.params.data;s[t.id]=t,i()}),e.on("select2:unselect",function(e){var t=e.params.data;s[t.id]=null,i()}),s){n=s[n];var a=new Option(n.text,n.id,!0,!0);e.append(a).trigger("change")}}r.slide.options.type?t(r.slide.options.type):r.selectType=function(e){t(r.slide.options.type=e)}},templateUrl:"/bundles/os2displayposter/apps/posterModule/posterTool.html"}}]);